Description: Use system libopenjpeg2
Author: Soren Stoutner <soren@stoutner.com>
Forwarded: https://bugreports.qt.io/browse/QTBUG-63889
Last-Update: 2023-02-14
---
This patch header follows DEP-3: http://dep.debian.net/deps/dep3/
--- a/configure.cmake
+++ b/configure.cmake
@@ -50,6 +50,7 @@
     pkg_check_modules(OPUS opus>=1.3.1)
     pkg_check_modules(VPX vpx>=1.10.0 IMPORTED_TARGET)
     pkg_check_modules(LIBPCI libpci)
+    pkg_check_modules(LIBOPENJP2 libopenjp2)
 endif()
 
 if(Python3_EXECUTABLE)
@@ -306,6 +307,10 @@
     LABEL "libwebp, libwebpmux and libwebpdemux"
     CONDITION UNIX AND WEBP_FOUND
 )
+qt_feature("webengine-system-libopenjpeg2" PRIVATE
+    LABEL "libopenjpeg2"
+    CONDITION UNIX AND LIBOPENJP2_FOUND
+)
 qt_feature("webengine-system-opus" PRIVATE
     LABEL "opus"
     CONDITION UNIX AND OPUS_FOUND
@@ -608,6 +613,7 @@
     qt_configure_add_summary_entry(ARGS "webengine-system-libxml")
     qt_configure_add_summary_entry(ARGS "webengine-system-lcms2")
     qt_configure_add_summary_entry(ARGS "webengine-system-libpng")
+    qt_configure_add_summary_entry(ARGS "webengine-system-libopenjpeg2")
     qt_configure_add_summary_entry(ARGS "webengine-system-libjpeg")
     qt_configure_add_summary_entry(ARGS "webengine-system-harfbuzz")
     qt_configure_add_summary_entry(ARGS "webengine-system-freetype")
--- a/src/core/CMakeLists.txt
+++ b/src/core/CMakeLists.txt
@@ -386,7 +386,7 @@
                 use_vaapi=false
             )
             set(systemLibs libjpeg libpng freetype harfbuzz libevent libwebp libxml
-                opus snappy libvpx icu ffmpeg re2 lcms2
+                opus snappy libvpx icu ffmpeg re2 lcms2 libopenjpeg2
             )
             foreach(slib ${systemLibs})
                 extend_gn_list(gnArgArg
--- a/src/pdf/CMakeLists.txt
+++ b/src/pdf/CMakeLists.txt
@@ -120,6 +120,10 @@
                 ARGS use_system_icu
                 CONDITION QT_FEATURE_webengine_system_icu
             )
+            extend_gn_list(gnArgArg
+                ARGS use_system_libopenjpeg2
+                CONDITION QT_FEATURE_webengine_system_libopenjpeg2
+            )
         endif()
         if(MACOS)
             list(APPEND gnArgArg angle_enable_vulkan=false)
